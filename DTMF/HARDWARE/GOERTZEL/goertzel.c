#include "goertzel.h"
#include "string.h"
#include "math.h"
#include "usart.h"
#include "oled.h"

#define PI 3.14
float InBufArray[NPT];
int signalnum=4;//设置显示数字个数
u8 display_position=0;//显示位置
u8 num_total=0;//已经显示几个数字
//float InBufArray[NPT]={
//-0.477752685546875,
//-0.204803466796875,
//0.154968261718750,
//0.270812988281250,
//0.129943847656250,
//-0.00167846679687500,
//0.0596313476562500,
//0.183227539062500,
//0.106048583984375,
//-0.202209472656250,
//-0.449462890625000,
//-0.338470458984375,
//0.0759887695312500,
//0.419097900390625,
//0.393096923828125,
//0.0857849121093750,
//-0.159515380859375,
//-0.145141601562500,
//-0.0147094726562500,
//-0.0261840820312500,
//-0.198150634765625,
//-0.273681640625000,
//-0.0504760742187500,
//0.327667236328125,
//0.490295410156250,
//0.248901367187500,
//-0.179290771484375,
//-0.401153564453125,
//-0.267486572265625,
//-0.00164794921875000,
//0.0957336425781250,
//0,
//-0.0478515625000000,
//0.114990234375000,
//0.332183837890625,
//0.299011230468750,
//-0.0525817871093750,
//-0.425689697265625,
//-0.461029052734375,
//-0.130249023437500,
//0.236206054687500,
//0.317077636718750,
//0.135009765625000,
//-0.0223083496093750,
//0.0223693847656250,
//0.128112792968750,
//0.0427246093750000,
//-0.240417480468750,
//-0.427062988281250,
//-0.256042480468750,
//0.171203613281250,
//0.467559814453125,
//0.370910644531250,
//0.0184936523437500,
//-0.227050781250000,
//-0.187133789062500,
//-0.0316162109375000,
//-0.0221557617187500,
//-0.165496826171875,
//-0.207489013671875,
//0.0263366699218750,
//0.367645263671875,
//0.458923339843750,
//0.160461425781250,
//-0.268981933593750,
//-0.439910888671875,
//-0.245544433593750,
//0.0524902343750000,
//0.150451660156250,
//0.0441894531250000,
//-0.0151367187500000,
//0.124267578125000,
//0.297485351562500,
//0.220001220703125,
//-0.137481689453125,
//-0.461120605468750,
//-0.421112060546875,
//-0.0423889160156250,
//0.315277099609375,
//0.348480224609375,
//0.120208740234375,
//-0.0602722167968750,
//-0.0238952636718750,
//0.0754394531250000,
//-0.00646972656250000,
//-0.257049560546875,
//-0.384979248046875,
//-0.165985107421875,
//0.257293701171875,
//0.494628906250000,
//0.326171875000000,
//-0.0617980957031250,
//-0.293548583984375,
//-0.216369628906250,
//-0.0299072265625000,
//0,
//-0.121490478515625,
//-0.141937255859375,
//0.0889892578125000,
//0.384826660156250,
//0.406982421875000,
//0.0643005371093750,
//-0.349609375000000,
//-0.458129882812500,
//-0.202117919921875,
//0.119781494140625,
//0.206085205078125,
//0.0779113769531250,
//-0.000244140625000000,
//0.114044189453125,
//0.249206542968750,
//0.140411376953125,
//-0.207946777343750,
//-0.473083496093750,
//-0.360412597656250,
//0.0530395507812500,
//0.385864257812500,
//0.360778808593750,
//0.0849914550781250,
//-0.111968994140625,
//-0.0733337402343750,
//0.0310974121093750,
//-0.0379638671875000,
//-0.252624511718750,
//-0.327606201171875,
//-0.0747680664062500,
//0.328552246093750,
//0.498077392578125,
//0.261016845703125,
//-0.149658203125000,
//-0.352844238281250,
//-0.228515625000000,
//-0.00866699218750000,
//0.0372314453125000,
//-0.0718078613281250,
//-0.0830993652343750,
//0.133636474609375,
//0.379455566406250,
//0.338684082031250,
//-0.0331115722656250,
//-0.415344238281250,
//-0.453277587890625,
//-0.139099121093750,
//0.195037841796875,
//0.256408691406250,
//0.0966186523437500,
//-0.00454711914062500,
//0.0870056152343750,
//0.192962646484375,
//0.0665283203125000,
//-0.259735107421875,
//-0.461456298828125,
//-0.282958984375000,
//0.149658203125000,
//0.442138671875000,
//0.351379394531250,
//0.0309753417968750,
//-0.172698974609375,
//-0.119812011718750,
//3.05175781250000e-05,
//-0.0500488281250000,
//-0.229400634765625,
//-0.260467529296875,
//0.0111083984375000,
//0.380554199218750,
//0.477508544921875,
//0.179382324218750,
//-0.238891601562500,
//-0.399047851562500,
//-0.220581054687500,
//0.0310058593750000,
//0.0850830078125000,
//-0.0225524902343750,
//-0.0361938476562500,
//0.158081054687500,
//0.353546142578125,
//0.259521484375000,
//-0.125183105468750,
//-0.461608886718750,
//-0.424835205078125,
//-0.0599670410156250,
//0.272216796875000,
//0.295532226562500,
//0.0968627929687500,
//-0.0274658203125000,
//0.0472106933593750,
//0.134887695312500,
//0.00393676757812500,
//-0.290313720703125,
//-0.427856445312500,
//-0.194213867187500,
//0.240875244140625,
//0.479309082031250,
//0.319305419921875,
//-0.0387878417968750,
//-0.236633300781250,
//-0.157440185546875,
//-0.0141601562500000,
//-0.0427246093750000,
//-0.191253662109375,
//-0.189758300781250,
//0.0857849121093750,
//0.410400390625000,
//0.434478759765625,
//0.0864562988281250
//};

//float InBufArray[NPT]={
//0.432642000000000,
//0,
//0,
//0,
//0.556714000000000,
//1.06428200000000,
//0.845142000000000,
//0.287622000000000,
//0.0966800000000000,
//0.378662000000000,
//0.727515000000000,
//0.466479000000000,
//0,
//0,
//0.0265870000000000,
//0.570410000000000,
//0.963574000000000,
//0.667895000000000,
//0.192554000000000,
//0.140186000000000,
//0.544629000000000,
//0.839502000000000,
//0.460840000000000,
//0,
//0,
//0.0531740000000000,
//0.584106000000000,
//0.873340000000000,
//0.509180000000000,
//0.111987000000000,
//0.215918000000000,
//0.698511000000000,
//0.901538000000000,
//0.457617000000000,
//0,
//0,
//0.107959000000000,
//0.575244000000000,
//0.722681000000000,
//0.294873000000000,
//0.00161100000000000,
//0.228003000000000,
//0.789551000000000,
//0.924097000000000,
//0.445532000000000,
//0,
//0,
//0.149048000000000,
//0.547046000000000,
//0.529321000000000,
//0.0572020000000000,
//0,
//0.211890000000000,
//0.839502000000000,
//0.902344000000000,
//0.406055000000000,
//0,
//0,
//0.165967000000000,
//0.476953000000000,
//0.291650000000000,
//0,
//0,
//0.290039000000000,
//0.932959000000000,
//0.935376000000000,
//0.402026000000000,
//0,
//0,
//0.236865000000000,
//0.441504000000000,
//0.106348000000000,
//0,
//0,
//0.397998000000000,
//1.01272000000000,
//0.992578000000000,
//0.401221000000000,
//0,
//0,
//0.306152000000000,
//0.365771000000000,
//0,
//0,
//0,
//0.486621000000000,
//1.06347700000000,
//0.938599000000000,
//0.382690000000000,
//0.0298100000000000,
//0.102319000000000,
//0.474536000000000,
//0.389136000000000,
//0,
//0,
//0,
//0.526904000000000,
//1.04816900000000,
//0.903955000000000,
//0.340796000000000,
//0.104736000000000,
//0.319849000000000,
//0.662256000000000,
//0.450366000000000,
//0,
//0,
//0,
//0.555103000000000,
//1.00305200000000,
//0.752490000000000,
//0.255396000000000,
//0.128101000000000,
//0.474536000000000,
//0.794385000000000,
//0.473730000000000,
//0,
//0,
//0.0241700000000000,
//0.551880000000000,
//0.887036000000000,
//0.564771000000000,
//0.147437000000000,
//0.184497000000000,
//0.628418000000000,
//0.862061000000000,
//0.465674000000000,
//0,
//0,
//0.0781490000000000,
//0.550269000000000,
//0.751685000000000,
//0.360938000000000,
//0.0443120000000000,
//0.221558000000000,
//0.745239000000000,
//0.925708000000000,
//0.478564000000000,
//0,
//0,
//0.0942630000000000,
//0.506763000000000,
//0.588135000000000,
//0.141797000000000,
//0,
//0.211084000000000,
//0.797607000000000,
//0.920068000000000,
//0.435059000000000,
//0,
//0,
//0.125684000000000,
//0.469702000000000,
//0.366577000000000,
//0,
//0,
//0.229614000000000,
//0.852393000000000,
//0.928125000000000,
//0.404443000000000,
//0,
//0,
//0.167578000000000,
//0.426196000000000,
//0.157910000000000,
//0,
//0,
//0.336768000000000,
//0.954712000000000,
//0.988550000000000,
//0.418140000000000,
//0,
//0,
//0.244922000000000,
//0.373828000000000,
//0,
//0,
//0,
//0.447949000000000,
//1.05300300000000,
//0.958740000000000,
//0.415723000000000,
//0.0257810000000000,
//0.0467290000000000,
//0.421362000000000,
//0.402026000000000,
//0,
//0,
//0,
//0.495483000000000,
//1.03930700000000,
//0.934570000000000,
//0.374634000000000,
//0.0829830000000000,
//0.233643000000000,
//0.587329000000000,
//0.439893000000000,
//0,
//0,
//0,
//0.511597000000000,
//0.997412000000000,
//0.822583000000000,
//0.308569000000000,
//0.128906000000000,
//0.411694000000000
//};

void GetPowerMag()
{
	
	char charvalue;
	u8 k[8] = {18,20,22,24,31,34,38,42};//k值
	int tm[4][4]={{1,2,3,65},{4,5,6,66},{7,8,9,67},{42,0,35,68}};//16个号码
	float w;//系数
	float Qkn[205];
	float Xk[8];
	
	int i,j,m,n;
	int temp;
	char stemp=' ';
	u8 limit =80;//门限阈值
	
	Qkn[0] = 0;
	Qkn[1] = 0;
	
	for(i=0;i<8;i++)
	{
		w=2*cos(2*PI*k[i]/205);
		for(j=2;j<205;j++)
		{
			Qkn[j] = w*Qkn[j-1]-Qkn[j-2]+InBufArray[j];
		}
		Xk[i] = fabs(pow(Qkn[204],2)+pow(Qkn[203],2)-w*Qkn[204]*Qkn[203]);
	}
	
	for(n=4;n<8;n++){
	  if(Xk[n] > limit) break;
	}
	for(m=0;m<4;m++){
	  if(Xk[m] > limit) break;
	}
//  printf("n is %d\r\n",n);
//	printf("m is %d\r\n",m);
	temp=tm[m][n-4];
	
   
   //printf("=====================\r\n" );
	
  if(num_total == signalnum){
	  num_total = 0;
		display_position=0;
		OLED_Clear();//清屏
	}
	if(temp > 9){
	  //printf("%c\r\n",temp);
		charvalue = temp;
		OLED_ShowChar(display_position,18,charvalue,24,1);
    
	}else{
	// printf("%d\r\n",temp);
		OLED_ShowNum(display_position,18,temp,1,24);
	}
	display_position+=12;
	num_total++;
	OLED_Refresh_Gram();		//更新显示到OLED 
	
}

//void GetPowerMag(float arr[])
//{
// 
//	u8 k[8] = {18,20,22,24,31,34,38,42};//k值
//	int tm[4][4]={{1,2,3,65},{4,5,6,66},{7,8,9,67},{42,0,35,68}};//16个号码
//	float w;//系数
//	float Qkn[205];
//	float Xk[8];
//	
//	int i,j,m,n;
//	int temp;
//	char stemp=' ';
//	u8 limit =80;//门限阈值
//	
//	Qkn[0] = 0;
//	Qkn[1] = 0;
//	
//	for(i=0;i<8;i++)
//	{
//		w=2*cos(2*PI*k[i]/205);
//		for(j=2;j<205;j++)
//		{
//			Qkn[j] = w*Qkn[j-1]-Qkn[j-2]+arr[j];
//		}
//		Xk[i] = fabs(pow(Qkn[204],2)+pow(Qkn[203],2)-w*Qkn[204]*Qkn[203]);
//	}
//	
//	for(n=0;n<4;n++){
//	  if(Xk[n] > limit) break;
//	}
//	for(m=0;m<4;m++){
//	  if(Xk[m] > limit) break;
//	}
//	printf("n is %d\r\n",n);
//	printf("m is %d\r\n",m);
//	temp=tm[m][n];
//	
//	switch(temp){
//	  case 65:stemp='a';
//		case 66:stemp='b';
//		case 67:stemp='c';
//		case 68:stemp='d';
//		default:break;
//	}
//	printf("it is formal %d\r\n",temp);
//	printf("it is noforma %c\r\n",stemp);
//}

